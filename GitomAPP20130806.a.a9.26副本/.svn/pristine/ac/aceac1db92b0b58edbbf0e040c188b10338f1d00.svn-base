//
//  ChooseViewController.m
//  IOS_Javascript
//
//  Created by GitomYiwan on 13-7-8.
//  Copyright (c) 2013年 GitomYiwan. All rights reserved.
//

#import "ChooseViewController.h"
#import "JASidePanelController.h"//抽屉效果
#import "UIViewController+JASidePanel.h"
#import <QuartzCore/QuartzCore.h>
#import "CustomManger.h"//
//#import "CustomButton.h"
#import "Custom.h"
//#import "WebViewController.h"
#import "ViewController.h"

#import <ShareSDK/ShareSDK.h>
#import "UIImageView+Dcgimage.h"
#import "LoginStatueSingal.h"//存储登入状态的单例
#import "GetLabelHightAndBreakLines.h"//实现UILabel自动换行的类

//#import "UserStatue.h"//用户状态视图

@interface ChooseViewController ()

@end

@implementation ChooseViewController




- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

#pragma mark -- 用户验证好重新加载界面
- (void)viewWillAppear:(BOOL)animated
{
    //NSLog(@"%s",__FUNCTION__);
   
    
    LoginStatueSingal *logSingal = [LoginStatueSingal shareLogStatu];
    _loginFlag = logSingal.logStatu;//单例传参
    
    if (_loginFlag == 1) {
        //[self viewDidLoad];
        //NSLog(@"登入的状态");
        
        [_headView removeFromSuperview];
        _headView.backgroundColor = [UIColor whiteColor];
        
        UserStatue *userStatue = [[UserStatue alloc]initWithFrame:CGRectMake(0, 0, Screen_Width, 100)];
        //NSLog(@"用户编号=== %@",logSingal.userNumber);
        userStatue.userNumber = logSingal.userNumber;//通单例获得编号
        //NSLog(@"用户编号=== %@",userStatue.userNumber);
        userStatue.userStatueDelegat = self;//设置代理
        [self.view addSubview:userStatue];
        
        
        //用户头像
        UIImageView * userImg = [[UIImageView alloc]initWithFrame:CGRectMake(15, 18, 64, 64 )];
        userImg.backgroundColor = [UIColor clearColor];
        userImg.image = [UIImage imageWithData:logSingal.userImgData];
        [userStatue addSubview:userImg];
        
        //用户编号
        UILabel *userNumberLabel = [[UILabel alloc]initWithFrame:CGRectMake(90, 44, 100, 18)];
        userNumberLabel.text = logSingal.userNumber;
        userNumberLabel.backgroundColor = [UIColor clearColor];
        userNumberLabel.textColor = [UIColor whiteColor];
        userNumberLabel.font = [UIFont systemFontOfSize:12];
        [userStatue addSubview:userNumberLabel];
        
        //用户姓名
        UILabel *userNameLabel = [[UILabel alloc]init ];//WithFrame:CGRectMake(110, 18, 150, 30)];
        GetLabelHightAndBreakLines *getLabelHight = [[GetLabelHightAndBreakLines alloc]init];
        CGFloat labelHight = [getLabelHight highOfLabel:userNameLabel
                                      numberTextOfLabel:logSingal.userName
                                            andFontSize:20];
        userNameLabel.frame = CGRectMake(88, 18, 165, labelHight);
        
        userNameLabel.text = logSingal.userName;
        userNameLabel.backgroundColor = [UIColor blackColor];
        userNameLabel.textColor = [UIColor whiteColor];
        userNameLabel.font = [UIFont systemFontOfSize:20];
        [userStatue addSubview:userNameLabel];
        
        _headView.frame = CGRectMake(0, 0, Screen_Width, 100);
        _appView.frame  = CGRectMake(0, _headView.bounds.size.height, 320, 320);
        _aboutView.frame = CGRectMake(0, _headView.bounds.size.height, 320, 320);
    }
    
}

#pragma mark -- UserStatue的代理方法
#pragma mark 切换账号
- (void)presentToShiftView
{
    LoginStatueSingal *logSingal = [LoginStatueSingal shareLogStatu];
    logSingal.shiftStatu = 1;//登入界面 已经有账号登入的标记
    logSingal.logStatu = 2;//标记非1时候界面ViewController不刷新

    ViewController *vc = [[ViewController alloc]init];
    vc.imgFlag = 3;
    [self presentViewController:vc animated:YES completion:^{
        nil;
    }];
}
#pragma mark 会员中心
- (void)presentToVipView
{
    ViewController *vc = [[ViewController alloc]init];
    vc.imgFlag = 6;
    //NSLog(@"进入会员中心");
    [self presentViewController:vc animated:YES completion:^{
        nil;
    }];
}


- (void)viewDidLoad
{
    [super viewDidLoad];
    
    self.view.backgroundColor = BackgroundColor_DarkBlack;//colorWithRed:59/255.0 green:66/255.0 blue:74/255.0 alpha:1];
    
    _headView = [[UIView alloc]initWithFrame:CGRectZero];
    _headView.backgroundColor = [UIColor blackColor];
    [self.view addSubview:_headView];

    //NSLog(@"未登入");
    _buttonTitle = @"登入";
    _headView.frame = CGRectMake(0, 0, 320, 50);
        
    UIButton *loginBT = [UIButton buttonWithType:UIButtonTypeCustom];
    loginBT.backgroundColor = [UIColor colorWithRed:59/255.0 green:66/255.0 blue:74/255.0 alpha:1];
        
    [loginBT addTarget:self action:@selector(userLog) forControlEvents:UIControlEventTouchUpInside];
    [loginBT setImage:[UIImage imageNamed:@"bottom_bg.png"] forState:UIControlStateHighlighted];
    [loginBT setTintColor:[UIColor whiteColor]];
    [loginBT setTitle:_buttonTitle forState:UIControlStateNormal];
    loginBT.frame = CGRectMake(8, 5, Screen_Width - 80, 40);
    [_headView addSubview:loginBT];

    //NSLog(@"企业定制应用");
    //企业定制应用
    _appView = [[UIView alloc]initWithFrame:CGRectMake(0, _headView.bounds.size.height, 320, 366)];
    _appView.backgroundColor = BackgroundColor_DarkBlack;
    [self.view addSubview:_appView];
    //遍历出按钮
    _custom = [[CustomManger alloc]connectWithCustomURL:@"http://gapp.gitom.com/api/getDefaultMenuList.json?packname=com.gitom.app" getIndex:0];//解析json
    //NSLog(@"数组的数量%d",_custom.customAr.count);
    if (_custom.customAr.count == 1) {
        
        _refreshButton = [UIButton buttonWithType:UIButtonTypeCustom];
        [_refreshButton setBackgroundColor:[UIColor colorWithPatternImage:[UIImage imageNamed:@"myRefresh.png"]]];
        [_refreshButton setBackgroundImage:[UIImage imageNamed:@"myRefresh_press.png"] forState:UIControlStateHighlighted];
        [_refreshButton addTarget:self action:@selector(refreshAction) forControlEvents:UIControlEventTouchUpInside];
        _refreshButton.frame = CGRectMake(10, 10, 64, 58);
        [_appView addSubview:_refreshButton];
        
        
    }else{
        for (int i=0;i<_custom.customAr.count ; i++) {
            
            //NSLog(@"遍历按钮");
            _custom = [[CustomManger alloc]connectWithCustomURL:@"http://gapp.gitom.com/api/getDefaultMenuList.json?packname=com.gitom.app" getIndex:i ];//解析json
            _cusBT = [[CustomButton alloc]initWithFrame:CGRectMake(10+76*(i%3), 10+70*(i/3), 64, 58)];
            _cusBT.connectDL = self;//设置“按钮”的代理
            _cusBT.titleLB.text = _custom.title;
            //cusBT.imgIcon.image = _custom.img;
            NSString *http = [_custom.imgUrl substringWithRange:NSMakeRange(0, 4)];
            if ([http isEqualToString:@"http"]) {//对解析的到的图片地址进行逻辑判断：本地、服务器
                [_cusBT.imgIcon setImageFronUrl:_custom.imgUrl];
            }else{
                _cusBT.imgIcon.image = [UIImage imageNamed:_custom.imgUrl];
            }
            
            //NSLog(@"图片链接%@",_custom.imgUrl);
            _cusBT.webUrl = _custom.paramer;
            _cusBT.tag = 2000+i;
            _cusBT.btTag = _cusBT.tag;
            [_appView addSubview:_cusBT];
            
        }
    }
    [self loadButtons];
    
}


#pragma mark -- CustomButton的代理方法
//static int pushToWebFlag = 1;
- (void)pushToWeb:(int)tag
{
    
    
    _cusBT = (CustomButton *)[self.view viewWithTag:tag];
    //vi.webUrl = cusBT.webUrl;
    LoginStatueSingal *singal = [LoginStatueSingal shareLogStatu];
    singal.logStatu = 2;//只要不是1，就不会重复加载出用户首页
    if (_cusBT.webUrl) {
        //NSLog(@"cusBT.webUrl == nil");
   
    //报错原因：
    /*-[UIView webUrl]: unrecognized selector sent to instance 0x1e58af50
      2013-08-03 17:24:12.477 GitomAPP[3238:907] *** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '-[UIView webUrl]: unrecognized selector sent to instance 0x1e58af50'
      *** First throw call stack:
      */
    singal.casUrl = _cusBT.webUrl;

    ViewController *vi = [[ViewController alloc]init];
    vi.imgFlag =1;
    vi.navtitle = _cusBT.titleLB.text;
    //NSLog(@"cusBT.titleLB.text == %@",_cusBT.titleLB.text);
   // NSLog(@"tagessss === %d",_cusBT.btTag);
    //NSLog(@"__cusBT.webUrl==%@",_cusBT.webUrl);
    
    [self presentViewController:vi animated:YES completion:^{
            nil;
        }];
    }else{
        nil;
    }
}

#pragma mark -- 底部操作按钮
- (void)loadButtons
{
    
//    _buttomBt1 = [[UIView alloc]initWithFrame:CGRectMake(0, Screen_Height-62, 80, 44)];
//    _buttomBt1.backgroundColor = [UIColor blackColor];
//    //    buttomBt1.backgroundColor = [UIColor whiteColor];
//    UILabel *title1 = [[UILabel alloc]initWithFrame:CGRectMake(23, 12, 40, 16)];
//    title1.textColor = [UIColor whiteColor];
//    title1.backgroundColor = [UIColor clearColor];
//    title1.text = @"退出";
//    [self.view addSubview:_buttomBt1];
//    UITapGestureRecognizer *tap1 = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(quite)];
//    [_buttomBt1 addGestureRecognizer:tap1];
//    [_buttomBt1 addSubview:title1];
    
    _buttomBt2 = [[UIView alloc]initWithFrame:CGRectMake(3, Screen_Height-62, 120, 39)];
    _buttomBt2.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png_press.png"]];
    _buttomBt2.layer.cornerRadius = 5;
    //buttomBt2.backgroundColor = [UIColor grayColor];
    [self.view addSubview:_buttomBt2];
    UITapGestureRecognizer *tap2 = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(app)];
    [_buttomBt2 addGestureRecognizer:tap2];
    UILabel *title2 = [[UILabel alloc]initWithFrame:CGRectMake(_buttomBt2.frame.size.width/2-20, _buttomBt2.frame.size.height/2-8, 40, 16)];
    title2.textColor = [UIColor whiteColor];
    title2.backgroundColor = [UIColor clearColor];
    title2.text = @"应用";
    [_buttomBt2 addSubview:title2];
    
    _buttomBt3 = [[UIView alloc]initWithFrame:CGRectMake(_buttomBt2.frame.size.width+5, Screen_Height-62, 120, 39)];
    _buttomBt3.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1.png"]];
    _buttomBt3.layer.cornerRadius = 5;
    //    buttomBt3.backgroundColor = [UIColor whiteColor];
    [self.view addSubview:_buttomBt3];
    UITapGestureRecognizer *tap3 = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(about)];
    [_buttomBt3 addGestureRecognizer:tap3];
    UILabel *title3 = [[UILabel alloc]initWithFrame:CGRectMake(_buttomBt3.frame.size.width/2-20, _buttomBt3.frame.size.height/2-8, 40, 16)];
    title3.textColor = [UIColor whiteColor];
    title3.backgroundColor = [UIColor clearColor];
    title3.text = @"关于";
    [_buttomBt3 addSubview:title3];
}

//退出
//- (void)quite
//{
//    _buttomBt1.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png.9.png"]];
//    _buttomBt3.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png.9.png"]];
//    _buttomBt1.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png_press.9.png"]];
//    //有了该退出方法，将无法上架APPStroe
//    [[UIApplication sharedApplication] performSelector:@selector(terminateWithSuccess)];
//    exit(0);
//}

- (void)app
{
    [_aboutView removeFromSuperview];
    [self.view addSubview:_appView];
    
    _buttomBt2.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png_press.png"]];
    //_buttomBt1.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png.9.png"]];
    _buttomBt3.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1.png"]];
    
}

- (void)about
{
    [_appView removeFromSuperview];
    
    //_buttomBt1.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png.9.png"]];
    _buttomBt2.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1.png"]];
    //_buttomBt1.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png.9.png"]];
    _buttomBt3.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"button_style_1_png_press.png"]];
    
    //关于页面
    _aboutView = [[UIView alloc]initWithFrame:CGRectMake(0, 50, 320, 366)];
    _aboutView.frame = CGRectMake(0, _headView.bounds.size.height, 320, 320);
    [self.view addSubview:_aboutView];
    
    
    UIView *shareV = [self creatAboutViewsSetTitle:@"分享应用" andImg:@"glyphicons_308_share_alt.png" andFrame:CGRectMake(10, 5, 230, 40) andSelect:@selector(shareSL)];
    shareV.tag = 3001;
    [_aboutView addSubview:shareV];
    
    UIView *updataV = [self creatAboutViewsSetTitle:@"查询更新" andImg:@"glyphicons_365_restart.png" andFrame:CGRectMake(10, 50, 230, 40) andSelect:@selector(restartSL)];
    updataV.tag = 3002;
    [_aboutView addSubview:updataV];
    
    UIView *feedV = [self creatAboutViewsSetTitle:@"意见反馈" andImg:@"glyphicons_234_brush.png" andFrame:CGRectMake(10, 95, 230, 40) andSelect:@selector(feedBackSL)];
    feedV.tag = 3003;
    [_aboutView addSubview:feedV];
    
    
    UIView *aboutV = [self creatAboutViewsSetTitle:@"关于" andImg:@"glyphicons_258_qrcode.png" andFrame:CGRectMake(10, 140, 230, 40) andSelect:@selector(aboutSL)];
    aboutV.tag = 3004;
    [_aboutView addSubview:aboutV];
    
}

//创建关于内条形按钮
- (UIView *)creatAboutViewsSetTitle:(NSString *)aTitle
                         andImg:(NSString *)imgName
                       andFrame:(CGRect)aFrame
                      andSelect:(SEL)select
{
    UIView *about = [[UIView alloc]initWithFrame:aFrame];
    about.layer.shadowColor = [UIColor blackColor].CGColor;
    about.layer.shadowOffset = CGSizeMake(4, 4);
    about.layer.shadowOpacity = .5;
    
    about.backgroundColor = [UIColor colorWithRed:61/255.0 green:71/255.0 blue:82/255.0 alpha:1];
    UILabel *titleLB = [[UILabel alloc]initWithFrame:CGRectMake(75, 12.5, 80, 15)];
    titleLB.textAlignment = NSTextAlignmentCenter;
    titleLB.textColor = [UIColor whiteColor];
    titleLB.backgroundColor = [UIColor clearColor];
    titleLB.text = aTitle;
    
    UIImageView *imgView = [[UIImageView alloc]initWithFrame:CGRectMake(5, 9, 22, 22)];
    imgView.image = [UIImage imageNamed:imgName];
    [about addSubview:imgView];
    [about addSubview:titleLB];
    
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:select];
    [about addGestureRecognizer:tap];
    
    return about;
}


- (void)shareSL
{
    //NSLog(@"分享");
    UIView *share = (UIView *)[self.view viewWithTag:3001];
    [UIView animateWithDuration:0.3 animations:^{
        //[UIView setAnimationTransition:UIViewAnimationTransitionFlipFromLeft forView:share cache:YES];
        share.backgroundColor = BackgroundColor_Green;
        share.backgroundColor = BackgroundColor_Black;
    }];
    
    
    //创建分享内容
    NSString *imagePath =  [[NSBundle mainBundle] pathForResource:@"logo"
                                                           ofType:@"png"];
    //构造分享内容
    id<ISSContent> publishContent = [ShareSDK content:@"真机测试 网即通移动版:http://app.gitom.com/MobileApp/detail/7"
                                       defaultContent:@"默认分享内容，没内容时显示"
                                                image:nil//[ShareSDK imageWithPath:imagePath]
                                                title:@"网即通"
                                                  url:@"http://app.gitom.com/MobileApp/detail/7"
                                          description:imagePath
                                            mediaType:SSPublishContentMediaTypeNews];
    
    NSArray *shareList1=[ShareSDK getShareListWithType:ShareTypeSinaWeibo,ShareTypeTencentWeibo,ShareTypeSohuWeibo,ShareTypeRenren,ShareType163Weibo,nil];
    
    id<ISSShareOptions> shareOptions = [ShareSDK defaultShareOptionsWithTitle:nil
                                                              oneKeyShareList:shareList1
                                                               qqButtonHidden:NO
                                                        wxSessionButtonHidden:NO
                                                       wxTimelineButtonHidden:NO
                                                         showKeyboardOnAppear:NO
                                                            shareViewDelegate:nil
                                                          friendsViewDelegate:nil
                                                        picViewerViewDelegate:nil];
    
    [ShareSDK showShareActionSheet:nil
                         shareList:shareList1
                           content:publishContent
                     statusBarTips:YES
                       authOptions:nil
                      shareOptions:shareOptions
                            result:^(ShareType type, SSPublishContentState state, id<ISSStatusInfo> statusInfo, id<ICMErrorInfo> error, BOOL end)
     {
         if (state == SSPublishContentStateSuccess)
         {
             NSLog(@"分享成功");
         }
         else if (state == SSPublishContentStateFail)
         {
             NSLog(@"分享失败,错误码:%d,错误描述:%@", [error errorCode],  [error errorDescription]);
         }
     }];
    
}

//版本更新
- (void)restartSL
{
    //NSLog(@"更新");
    UIView *restart = (UIView *)[self.view viewWithTag:3002];
    [UIView animateWithDuration:0.4 animations:^{
        //[UIView setAnimationTransition:UIViewAnimationTransitionFlipFromLeft forView:restart cache:YES];
        restart.backgroundColor = BackgroundColor_Green;
        restart.backgroundColor = BackgroundColor_Black;
    }];
    
    UIAlertView *alr = [[UIAlertView alloc]initWithTitle:@"提示" message:@"还未出新版本" delegate:self cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
    [alr show];
    
}

- (void)feedBackSL
{
    //NSLog(@"意见反馈");
    UIView *restart = (UIView *)[self.view viewWithTag:3003];
    [UIView animateWithDuration:0.3 animations:^{
    //[UIView setAnimationTransition:UIViewAnimationTransitionFlipFromLeft forView:restart cache:YES];
        restart.backgroundColor = BackgroundColor_Green;
        restart.backgroundColor = BackgroundColor_Black;
    }];
    
    //http://app.gitom.com/app/detail/125
    
    ViewController *vc = [[ViewController alloc]init];
    vc.imgFlag = 4;
    vc.navtitle = @"反馈";
    vc.webUrl = @"http://app.gitom.com/app/detail/125";
    //vc.modalTransitionStyle  = UIModalTransitionStylePartialCurl;
    //vc.modalPresentationStyle = UIModalPresentationFormSheet;
    [self presentViewController:vc animated:YES completion:^{
        nil;
    }];
    
}

- (void)aboutSL
{
    //NSLog(@"关于");
    UIView *about = (UIView *)[self.view viewWithTag:3004];
    
    [UIView animateWithDuration:0.3 animations:^{
    //[UIView setAnimationTransition:UIViewAnimationTransitionFlipFromLeft forView:about cache:YES];
        about.backgroundColor = BackgroundColor_Green;
        about.backgroundColor = BackgroundColor_Black;
    }];
    
    
    ViewController *vc = [[ViewController alloc]init];
    vc.imgFlag = 2;
    vc.navtitle = @"关于";
    //vc.modalTransitionStyle = UIModalTransitionStylePartialCurl;
    //vc.webUrl = @"http://app.gitom.com/app/detail/125";
    [self presentViewController:vc animated:YES completion:^{
        nil;
    }];
}

#pragma mark -- 登入
- (void)userLog
{
    
    //NSLog(@"用户登入");
    ViewController *vc = [[ViewController alloc]init];
    vc.imgFlag = 3;
    vc.navtitle = @"用户登入";
    
    [self presentViewController:vc animated:YES completion:^{
        nil;
    }];
    
}

//刷新
- (void)refreshAction
{
    //NSLog(@"刷新");
//    [_refreshButton setBackgroundColor:BackgroundColor_Green];
//    [UIView animateWithDuration:0.5 animations:^{
//        [UIView setAnimationTransition:UIViewAnimationTransitionFlipFromLeft forView:_refreshButton cache:YES];
//    }];
    [self viewDidLoad];
}




- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end
